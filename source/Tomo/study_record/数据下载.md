# 1. 数据准备
## **1.1 介绍**

 1. 我需要做远震体波的有限频层析成像，选择的台网有`CIFALPs-1`, `CIFALPS-2` 和开放的欧洲永久地震台网。
 因此我的需求是: 
    1. 根据台站的位置来下载特定震中距范围内`(30~110)`的地震事件

    2. 下载地震事件目录，筛选出在距离我研究区域震中距大约`(30~110)`范围内的所有地震事件，然后再批量下载.
        
        按照地震事件目录来存放下载的数据

## **1.2 我所需要用到的地震事件，台网**

在`IRIS`的`gmap`功能上可以查询并下载研究区域中的地震台网信息（可以查询台站的`channe`，这一点非常方便）：

<http://ds.iris.edu/gmap/#network=CH&station=*&starttime=2019-09-01&endtime=2019-12-08&planet=earth>

 1. 台网
    * 欧洲地震数据库(EIDA: Europen Integrated Data Archive)

        <http://www.orfeus-eu.org/data/eida/>

        1. CH: <https://www.fdsn.org/networks/detail/CH/> 

            Data center: ~SED~, ETH & IRIS(FDSN中没有SED数据库，需要自行去官网下载`stationxml`
            ，但是可以利用`mass_downloader`下载`SED`的波形数据，`SED`数据库可以用`ETH`来代替)  

            利用`Geo`查询得到的与利用obspy`get_station()`函数下载的台站信息有一处差别：
            `CH.MFERR`台站, 在`Geo`上查得该台站的信息在我所要的时间段内的`channel`为`EH*`，
            也即是说该台站信息应该舍去。


            Period：~ 2020/12/20
        
        2. FR: <https://www.fdsn.org/networks/detail/FR/> 
        
            Data center: RESIF

            Period: 1962 ~ now 

        3. RD:
        
            Data center: RESIF

        4. G: <https://www.fdsn.org/networks/detail/G/>
        
            Data center: RESIF

            Period: 1982 ~ now

        5. IV:<https://www.fdsn.org/networks/detail/IV/>

            Data center: INGV

            Period: 1988 ~ now

        6. GU：<https://www.fdsn.org/networks/detail/GU/>

            Data center: INGV

            Period: 1967 ~ now

 2. 地震仪类型

    * BH（NEZ）：      

## **1.3 数据下载**

 时间段：CIFALPS2(2018-9-13 ~ 2019-12-5)

 <https://seismology.resif.fr/fr/reseaux/#/XT__2018>

 **1. Research areas**  
    latitude : 38 ~ 50  
    longitude: 0  ~ 20

**2. Data Download**
 * 获取地震事件目录（观测时间，震级，震中距）
   1. 现根据一个区域（eg: [0~20]x[38~50]）的中心经纬度截取地震事件，震中距`30~110`，震级>5.5;

利用`obspy`模块中的`Massdownloader`进行批量数据下载(在下载前需要利用`get_event`模块下载地震事件目录)，其具体代码如下：
1. 地震事件目录下载
```python
    from obspy.clients.fdsn import Client
    from obspy import UTCDateTime

    client = Client("IRIS")

    starttime = UTCDateTime("2018-9-13")
    endtime = UTCDateTime("2019-12-05")

    # 以一个（lat, long）为中心筛选特定震中距发生的地震事件
    latitude = 44
    longitude = 10
    minradius = 30
    maxradius = 120
    minmagnitude = 5.5
    # 储存目录
    output_file = "./event_catalog/event_catalog"

    cat = client.get_events(starttime=starttime, endtime=endtime,
                            latitude=latitude, longitude=longitude,
                            minradius=minradius, maxradius=maxradius,
                            minmagnitude=minmagnitude,
                            includeallorigins=True,
                            filename=output_file
                            )
 ```
2. 数据下载
```python
# Download data through "mass.downloader"
# Based on seismic event catalogs
import os
import obspy

from obspy import read_events
from obspy.clients.fdsn.mass_downloader import CircularDomain, \
    RectangularDomain, Restrictions, MassDownloader

# 从地震事件目录中读取事件，然后下载数据
cata_dir = "./bin/event_catalog/event_catalog"
cat = read_events(cata_dir)
id = 10    # id, id of event in cata
origin_time = cat.events[id].origins[0].time

# output dir
year = origin_time.year
month = origin_time.month
day = origin_time.day
hour = origin_time.hour
minute = origin_time.minute
second = origin_time.second
microsecond = origin_time.microsecond
output_dir = "./%s_%s_%s_%s_%s_%s_%s" % (year, month, day,
                                         hour, minute, second,
                                         microsecond)

# Circular domain around the epicenter. This will download all data between
# 70 and 90 degrees distance from the epicenter. This module also offers
# rectangular and global domains. More complex domains can be defined by
# inheriting from the Domain class.
#domain = CircularDomain(latitude=37.52, longitude=143.04,
#                       minradius=70.0, maxradius=90.0)

# domain where stations location.
domain = RectangularDomain(minlatitude=38, maxlatitude=50,
                           minlongitude=0, maxlongitude=20)

# Para of Restrictions
start_time = origin_time - 60
end_time = origin_time + 3600


restrictions = Restrictions(
    # Get data from 5 minutes before the event to one hour after the
    # event. This defines the temporal bounds of the waveform data.
    starttime=start_time,
    endtime=end_time,

    # You might not want to deal with gaps in the data. If this setting is
    # True, any trace with a gap/overlap will be discarded.
    reject_channels_with_gaps=True,
    # And you might only want waveforms that have data for at least 95 % of
    # the requested time span. Any trace that is shorter than 95 % of the
    # desired total duration will be discarded.
    minimum_length=0.95,
    # No two stations should be closer than 10 km to each other. This is
    # useful to for example filter out stations that are part of different
    # networks but at the same physical station. Settings this option to
    # zero or None will disable that filtering.
    minimum_interstation_distance_in_m=10E3,
    # Only HH or BH channels. If a station has HH channels, those will be
    # downloaded, otherwise the BH. Nothing will be downloaded if it has
    # neither. You can add more/less patterns if you like.
    channel_priorities=["BH[ZNE]", "HH[ZNE]"],
    # Location codes are arbitrary and there is no rule as to which
    # location is best. Same logic as for the previous setting.
    #location_priorities=["", "00", "10"]
    )

# No specified providers will result in all known ones being queried.
mdl = MassDownloader()
# The data will be downloaded to the ``./waveforms/`` and ``./stations/``
# folders with automatically chosen file names.
# 创建一个目录，储存waveforms和station

mdl.download(domain, restrictions, mseed_storage="./%s/waveform" % output_dir,
             stationxml_storage="./%s/station" % output_dir)
```